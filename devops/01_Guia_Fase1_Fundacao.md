# Guia de Implementação: Fase 1 - Fundação & Dados (Clean Slate)
**Versão:** 1.0
**Objetivo:** Criar a estrutura de base de dados "do zero", garantindo que não existem conflitos com versões anteriores.

---

## ⚠️ AVISO: Clean Slate (Apagar Tudo)
O script abaixo **APAGARÁ** todas as tabelas e objetos de sistema relacionados com o projeto no seu Schema atual.
Execute apenas se tiver a certeza que quer reiniciar o ambiente.

### 1. Verificação de Pré-Requisitos (Novo)
Antes de começar, verifique a compatibilidade do seu ambiente.
Corra este bloco no **SQL Commands**:

```sql
BEGIN
    DBMS_OUTPUT.PUT_LINE('--- Verificação de Ambiente ---');
    
    -- 1. Versão da Base de Dados
    FOR r IN (SELECT banner FROM v$version WHERE ROWNUM = 1) LOOP
        DBMS_OUTPUT.PUT_LINE('Versão DB: ' || r.banner);
    END LOOP;

    -- 2. Teste de Suporte a Booleanos Nativos
    BEGIN
        EXECUTE IMMEDIATE 'CREATE TABLE teste_bool_check (val BOOLEAN)';
        EXECUTE IMMEDIATE 'DROP TABLE teste_bool_check';
        DBMS_OUTPUT.PUT_LINE('Suporte a Booleans em Tabelas: [SIM] - Pode usar BOOLEAN');
    EXCEPTION WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Suporte a Booleans em Tabelas: [NÃO] - O Guia usará VARCHAR2(1)');
    END;
    
    DBMS_OUTPUT.PUT_LINE('-----------------------------');
END;
/
```
*Se o resultado for "NÃO", este guia já está preparado para usar a abordagem compatível (Y/N).*

### 2. Script de Limpeza (Clean Slate)
Copie e corra no **SQL Commands**:

```sql
BEGIN
    -- Apagar tabelas conhecidas do projeto (Ordem inversa às dependências)
    FOR t IN (
        SELECT table_name FROM user_tables 
        WHERE table_name IN (
            'BADGES_ATRIBUIDOS', 'PRESENCAS', 'MATRICULAS', 'INSCRITOS', 
            'SESSOES', 'TURMAS', 'CURSOS', 'PRE_INSCRICOES', 
            'ARQUIVOS_ANEXOS', 'LOG_ACOES', 
            'TURMA_COMPETENCIAS_LECIONADAS', 'DESAFIOS_TURMA',
            'DOSSIER_CONTROLO', 'EQUIPAMENTOS_ALOCADOS',
            'INSCRICOES' -- Tabela antiga se existir
        ) 
        OR table_name LIKE 'TIPOS_%' -- Apaga tabelas de Lookup
    ) LOOP
        EXECUTE IMMEDIATE 'DROP TABLE ' || t.table_name || ' CASCADE CONSTRAINTS';
    END LOOP;

    -- Apagar Trigger específico pedido
    BEGIN
        EXECUTE IMMEDIATE 'DROP TRIGGER TRG_TURMAS_BIU';
    EXCEPTION WHEN OTHERS THEN NULL; -- Ignora erro se não existir
    END;
    
    -- Apagar Sequências (se existirem fora dos Identity columns)
    FOR s IN (SELECT sequence_name FROM user_sequences WHERE sequence_name LIKE 'SEQ_%') LOOP
        EXECUTE IMMEDIATE 'DROP SEQUENCE ' || s.sequence_name;
    END LOOP;
END;
/
```

---

## 2. Criação dos Catálogos (Tipos e Tabelas Auxiliares)
O Modelo de Dados v4.0 define várias tabelas de "Lookup" (Listas de Opções). Vamos criar todas elas e povoá-las com os valores padrão.

**IMPORTANTE:** Como este passo contém muitas instruções (`CREATE`, `INSERT`), **não pode** ser corrido no "SQL Commands" normal (que só aceita uma de cada vez).
**Use a funcionalidade SQL Scripts:**
1. SQL Workshop > **SQL Scripts**.
2. Create > Script Name: `02_Catalogos`.
3. Cole o código abaixo e clique **Run**.

```sql
-- ==========================================
-- 2.1. Tabelas de Tipos (Lookups Simples)
-- ==========================================

-- Helper: Drop table se já existir (redundante com o passo 1 mas seguro)
-- Nota: O script de limpeza (Passo 1) já tratou disto.

-- 1. Género
CREATE TABLE tipos_genero (
    id      NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    nome    VARCHAR2(50) NOT NULL
);
INSERT INTO tipos_genero (nome) VALUES ('Feminino');
INSERT INTO tipos_genero (nome) VALUES ('Masculino');
INSERT INTO tipos_genero (nome) VALUES ('Outro');
INSERT INTO tipos_genero (nome) VALUES ('Prefiro não dizer');

-- 2. Estado Turma
CREATE TABLE tipos_estado_turma (
    id      NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    nome    VARCHAR2(50) NOT NULL
);
INSERT INTO tipos_estado_turma (nome) VALUES ('Planeada');
INSERT INTO tipos_estado_turma (nome) VALUES ('Em Curso');
INSERT INTO tipos_estado_turma (nome) VALUES ('Concluída');
INSERT INTO tipos_estado_turma (nome) VALUES ('Cancelada');

-- 3. Área Competência (DigComp)
CREATE TABLE tipos_area_competencia (
    id      NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    nome    VARCHAR2(100) NOT NULL
);
INSERT INTO tipos_area_competencia (nome) VALUES ('Informação e Dados');
INSERT INTO tipos_area_competencia (nome) VALUES ('Comunicação e Colaboração');
INSERT INTO tipos_area_competencia (nome) VALUES ('Criação de Conteúdo');
INSERT INTO tipos_area_competencia (nome) VALUES ('Segurança');
INSERT INTO tipos_area_competencia (nome) VALUES ('Resolução de Problemas');

-- 4. Nível Proficiência
CREATE TABLE tipos_nivel_proficiencia (
    id      NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    nome    VARCHAR2(50) NOT NULL
);
INSERT INTO tipos_nivel_proficiencia (nome) VALUES ('Básico');
INSERT INTO tipos_nivel_proficiencia (nome) VALUES ('Intermédio');
INSERT INTO tipos_nivel_proficiencia (nome) VALUES ('Avançado');

-- 5. Estado Curso
CREATE TABLE tipos_estado_curso (
    id      NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    nome    VARCHAR2(50) NOT NULL
);
INSERT INTO tipos_estado_curso (nome) VALUES ('Ativo');
INSERT INTO tipos_estado_curso (nome) VALUES ('Inativo');
INSERT INTO tipos_estado_curso (nome) VALUES ('Em Desenvolvimento');

-- 6. Notificações
CREATE TABLE tipos_notificacao (
    id      NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    nome    VARCHAR2(50) NOT NULL
);
INSERT INTO tipos_notificacao (nome) VALUES ('Email');
INSERT INTO tipos_notificacao (nome) VALUES ('SMS');
INSERT INTO tipos_notificacao (nome) VALUES ('Sistema (Push)');

-- 7. Categoria Equipamento
CREATE TABLE tipos_categoria_equipamento (
    id      NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    nome    VARCHAR2(50) NOT NULL
);
INSERT INTO tipos_categoria_equipamento (nome) VALUES ('Computador Portátil');
INSERT INTO tipos_categoria_equipamento (nome) VALUES ('Tablet');
INSERT INTO tipos_categoria_equipamento (nome) VALUES ('Kit Robótica');
INSERT INTO tipos_categoria_equipamento (nome) VALUES ('Periférico (Rato/Teclado)');

-- 8. Estado Pré-Inscrição
CREATE TABLE tipos_estado_pre_inscricao (
    id      NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    nome    VARCHAR2(50) NOT NULL
);
INSERT INTO tipos_estado_pre_inscricao (nome) VALUES ('Nova');
INSERT INTO tipos_estado_pre_inscricao (nome) VALUES ('Processada');
INSERT INTO tipos_estado_pre_inscricao (nome) VALUES ('Duplicada');
INSERT INTO tipos_estado_pre_inscricao (nome) VALUES ('Erro');

-- 9. Documento Identificação
CREATE TABLE tipos_doc_identificacao (
    id      NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    nome    VARCHAR2(100) NOT NULL
);
INSERT INTO tipos_doc_identificacao (nome) VALUES ('Cartão de Cidadão');
INSERT INTO tipos_doc_identificacao (nome) VALUES ('Passaporte');
INSERT INTO tipos_doc_identificacao (nome) VALUES ('Título de Residência');

-- 10. Situação Profissional
CREATE TABLE tipos_situacao_profissional (
    id      NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    nome    VARCHAR2(100) NOT NULL
);
INSERT INTO tipos_situacao_profissional (nome) VALUES ('Empregado');
INSERT INTO tipos_situacao_profissional (nome) VALUES ('Desempregado');
INSERT INTO tipos_situacao_profissional (nome) VALUES ('Estudante');
INSERT INTO tipos_situacao_profissional (nome) VALUES ('Reformado');

-- 11. Estado Geral Inscrito
CREATE TABLE tipos_estado_geral_inscrito (
    id      NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    nome    VARCHAR2(50) NOT NULL
);
INSERT INTO tipos_estado_geral_inscrito (nome) VALUES ('Ativo');
INSERT INTO tipos_estado_geral_inscrito (nome) VALUES ('Suspenso');
INSERT INTO tipos_estado_geral_inscrito (nome) VALUES ('Inativo');

-- 12. Estado Dossier
CREATE TABLE tipos_estado_dossier (
    id      NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    nome    VARCHAR2(50) NOT NULL
);
INSERT INTO tipos_estado_dossier (nome) VALUES ('Pendente');
INSERT INTO tipos_estado_dossier (nome) VALUES ('Em Validação');
INSERT INTO tipos_estado_dossier (nome) VALUES ('Conforme');
INSERT INTO tipos_estado_dossier (nome) VALUES ('Arquivado');

-- 13. Estado Matrícula
CREATE TABLE tipos_estado_matricula (
    id      NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    nome    VARCHAR2(50) NOT NULL
);
INSERT INTO tipos_estado_matricula (nome) VALUES ('Inscrito'); -- Estado inicial
INSERT INTO tipos_estado_matricula (nome) VALUES ('A frequentar');
INSERT INTO tipos_estado_matricula (nome) VALUES ('Concluído com Sucesso');
INSERT INTO tipos_estado_matricula (nome) VALUES ('Desistiu');
INSERT INTO tipos_estado_matricula (nome) VALUES ('Reprovado');

-- 14. Nível Experiência
CREATE TABLE tipos_nivel_experiencia (
    id      NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    nome    VARCHAR2(50) NOT NULL
);
INSERT INTO tipos_nivel_experiencia (nome) VALUES ('Sem Experiência');
INSERT INTO tipos_nivel_experiencia (nome) VALUES ('Utilizador Básico');
INSERT INTO tipos_nivel_experiencia (nome) VALUES ('Utilizador Avançado');

-- 15. Estado Presença
CREATE TABLE tipos_estado_presenca (
    id      NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    nome    VARCHAR2(50) NOT NULL
);
INSERT INTO tipos_estado_presenca (nome) VALUES ('Presente');
INSERT INTO tipos_estado_presenca (nome) VALUES ('Falta Justificada');
INSERT INTO tipos_estado_presenca (nome) VALUES ('Falta Injustificada');

-- 16. Método Registo
CREATE TABLE tipos_metodo_registo (
    id      NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    nome    VARCHAR2(50) NOT NULL
);
INSERT INTO tipos_metodo_registo (nome) VALUES ('Manual (Formador)');
INSERT INTO tipos_metodo_registo (nome) VALUES ('QR Code');
INSERT INTO tipos_metodo_registo (nome) VALUES ('Automático (Login)');

-- 17. Estado Alocação
CREATE TABLE tipos_estado_alocacao (
    id      NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    nome    VARCHAR2(50) NOT NULL
);
INSERT INTO tipos_estado_alocacao (nome) VALUES ('Em Uso');
INSERT INTO tipos_estado_alocacao (nome) VALUES ('Devolvido');
INSERT INTO tipos_estado_alocacao (nome) VALUES ('Atrasado');
INSERT INTO tipos_estado_alocacao (nome) VALUES ('Danificado');

-- 18. Função Turma
CREATE TABLE tipos_funcao_turma (
    id      NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    nome    VARCHAR2(50) NOT NULL
);
INSERT INTO tipos_funcao_turma (nome) VALUES ('Formador');
INSERT INTO tipos_funcao_turma (nome) VALUES ('Coordenador');
INSERT INTO tipos_funcao_turma (nome) VALUES ('Técnico de Apoio');

-- 19. Estado Submissão
CREATE TABLE tipos_estado_submissao (
    id      NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    nome    VARCHAR2(50) NOT NULL
);
INSERT INTO tipos_estado_submissao (nome) VALUES ('Rascunho');
INSERT INTO tipos_estado_submissao (nome) VALUES ('Submetido');
INSERT INTO tipos_estado_submissao (nome) VALUES ('Aprovado');

-- 20. Plano DDF
CREATE TABLE tipos_plano_ddf (
    id      NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    nome    VARCHAR2(100) NOT NULL
);
INSERT INTO tipos_plano_ddf (nome) VALUES ('Formação Interna');
INSERT INTO tipos_plano_ddf (nome) VALUES ('Formação Externa');
INSERT INTO tipos_plano_ddf (nome) VALUES ('Formação para o Exterior');

-- 21. Qualificações (Habilitações)
CREATE TABLE tipos_de_qualificacao (
    id_qualificacao NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    nome            VARCHAR2(200) NOT NULL,
    nivel_qeq       NUMBER
);
INSERT INTO tipos_de_qualificacao (nome, nivel_qeq) VALUES ('Ensino Básico (9º Ano)', 2);
INSERT INTO tipos_de_qualificacao (nome, nivel_qeq) VALUES ('Ensino Secundário (12º Ano)', 3);
INSERT INTO tipos_de_qualificacao (nome, nivel_qeq) VALUES ('Pós-Secundário (CET)', 4);
INSERT INTO tipos_de_qualificacao (nome, nivel_qeq) VALUES ('Licenciatura', 6);
INSERT INTO tipos_de_qualificacao (nome, nivel_qeq) VALUES ('Mestrado', 7);
INSERT INTO tipos_de_qualificacao (nome, nivel_qeq) VALUES ('Doutoramento', 8);

-- 22. Tipos de Ação (Audit)
CREATE TABLE tipos_de_acao (
    id_tipo_de_acao NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    nome            VARCHAR2(100) NOT NULL,
    palavra_chave   VARCHAR2(50)
);
INSERT INTO tipos_de_acao (nome, palavra_chave) VALUES ('Pré-inscrição Recebida', 'PRE_INSCRICAO_RECEBIDA');
INSERT INTO tipos_de_acao (nome, palavra_chave) VALUES ('Inscrição Criada', 'INSCRICAO_CRIADA');
INSERT INTO tipos_de_acao (nome, palavra_chave) VALUES ('Matrícula Criada', 'MATRICULA_CRIADA');
INSERT INTO tipos_de_acao (nome, palavra_chave) VALUES ('Badge Emitido', 'BADGE_EMITIDO');

-- ==========================================
-- 2.2. Entidades de Catálogo (Estrutura Base)
-- ==========================================

-- Programas (Macro-estrutura)
CREATE TABLE programas (
    id_programa     NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    nome            VARCHAR2(200) NOT NULL,
    descricao       VARCHAR2(4000)
);
INSERT INTO programas (nome) VALUES ('Passaporte Competências Digitais');

-- Competências (DigComp)
CREATE TABLE competencias (
    id_competencia          NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    nome                    VARCHAR2(200) NOT NULL,
    id_area_competencia     NUMBER REFERENCES tipos_area_competencia(id),
    id_nivel_proficiencia   NUMBER REFERENCES tipos_nivel_proficiencia(id),
    url_medalha_digital     VARCHAR2(4000), -- Link para imagem do badge
    url_icone               VARCHAR2(4000)
);

-- Modelos de Comunicação (Emails)
CREATE TABLE modelos_de_comunicacao (
    id_modelo           NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    nome                VARCHAR2(200) NOT NULL,
    codigo_referencia   VARCHAR2(100), -- Ex: CONVOCATORIA_TURMA
    assunto             VARCHAR2(400),
    corpo_html          CLOB
);
INSERT INTO modelos_de_comunicacao (nome, codigo_referencia, assunto, corpo_html)
VALUES ('Convocatória Padrão', 'CONVOCATORIA', 'Acesso ao Curso [NOME_CURSO]', 'Olá [NOME], o seu link é [LINK].');

-- Comita as alterações
COMMIT;
```

---

## 3. Estrutura Core (Cursos e Turmas)
**Nota:** Como este bloco tem múltiplas instruções (Tabelas e Trigger), **execute via SQL Scripts** (ou corra comando a comando).

```sql
CREATE TABLE cursos (
    id_curso        NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    nome            VARCHAR2(200) NOT NULL,
    nome_sigo       VARCHAR2(200),
    carga_horaria   NUMBER, 
    modalidade      VARCHAR2(100) DEFAULT 'Presencial',
    ativo           VARCHAR2(1) DEFAULT 'Y',
    CONSTRAINT ck_curso_ativo CHECK (ativo IN ('Y', 'N'))
);

CREATE TABLE turmas (
    id_turma        NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    id_curso        NUMBER REFERENCES cursos(id_curso),
    nome            VARCHAR2(200) NOT NULL, -- Ex: "Turma Lisboa 01"
    num_informacao  VARCHAR2(100), -- Para faturas/SIGO
    data_inicio     DATE,
    data_fim        DATE,
    id_estado       NUMBER REFERENCES tipos_estado_turma(id),
    
    -- Auditoria
    created         TIMESTAMP DEFAULT SYSTIMESTAMP,
    created_by      VARCHAR2(200)
);

-- Trigger Auditoria Simples
CREATE OR REPLACE TRIGGER trg_turmas_audit
BEFORE INSERT ON turmas FOR EACH ROW
BEGIN
    :new.created_by := COALESCE(SYS_CONTEXT('APEX$SESSION','APP_USER'), USER);
END;
/
```

---

## 4. Estrutura de Pessoas (Inscritos e Matrículas)
**Use SQL Scripts** para garantir que as duas tabelas e o trigger são criados.

```sql
CREATE TABLE inscritos (
    id_inscrito         NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    nome_completo       VARCHAR2(200) NOT NULL,
    email               VARCHAR2(200) NOT NULL,
    nif                 NUMBER,
    telemovel           VARCHAR2(20),
    data_nascimento     DATE,
    
    -- Flags Legais
    consentimento_rgpd  VARCHAR2(1) DEFAULT 'N',
    
    created             TIMESTAMP DEFAULT SYSTIMESTAMP,
    CONSTRAINT uk_inscritos_email UNIQUE (email),
    CONSTRAINT uk_inscritos_nif UNIQUE (nif),
    CONSTRAINT ck_inscritos_rgpd CHECK (consentimento_rgpd IN ('Y', 'N'))
);

CREATE TABLE matriculas (
    id_matricula    NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    id_inscrito     NUMBER REFERENCES inscritos(id_inscrito),
    id_turma        NUMBER REFERENCES turmas(id_turma),
    
    -- Estado e Acesso
    estado          VARCHAR2(50) DEFAULT 'INSCRITO',
    token_acesso    VARCHAR2(64), -- Magic Link Token
    
    -- Controlo Processual
    email_enviado   VARCHAR2(1) DEFAULT 'N',
    badge_emitido   VARCHAR2(1) DEFAULT 'N',
    
    -- Avaliação
    nota_final      VARCHAR2(50),
    created         TIMESTAMP DEFAULT SYSTIMESTAMP,
    
    CONSTRAINT uk_matricula_unico UNIQUE (id_inscrito, id_turma),
    CONSTRAINT ck_matr_email CHECK (email_enviado IN ('Y', 'N')),
    CONSTRAINT ck_matr_badge CHECK (badge_emitido IN ('Y', 'N'))
);

-- Trigger para Gerar Token Automático
CREATE OR REPLACE TRIGGER trg_matriculas_token
BEFORE INSERT ON matriculas
FOR EACH ROW
BEGIN
    IF :new.token_acesso IS NULL THEN
        :new.token_acesso := DBMS_RANDOM.STRING('X', 32);
    END IF;
END;
/
```

---

## 5. Estrutura de Importação (Staging)

```sql
CREATE TABLE pre_inscricoes (
    id_pre_inscricao    NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    -- Campos "Flat" que vêm do Excel
    nome_completo       VARCHAR2(200),
    email               VARCHAR2(200),
    nif                 NUMBER,
    telemovel           VARCHAR2(20),
    curso_interesse     VARCHAR2(200),
    
    -- Link ao Perfil (Preenchido ao processar)
    id_inscrito         NUMBER REFERENCES inscritos(id_inscrito),
    
    -- Controlo
    data_importacao     TIMESTAMP DEFAULT SYSTIMESTAMP,
    estado_processamento VARCHAR2(20) DEFAULT 'PENDENTE', -- PENDENTE, ERRO, SUCESSO
    log_erro            VARCHAR2(4000)
);
```

---

## 6. Procedimento de Processamento (Logic)
O "Motor" que move dados do Staging para a Produção.

```sql
CREATE OR REPLACE PROCEDURE processar_importacao IS
    l_id_inscrito NUMBER;
    l_erro        VARCHAR2(4000);
BEGIN
    FOR r IN (SELECT * FROM pre_inscricoes WHERE estado_processamento = 'PENDENTE') LOOP
        BEGIN
            -- 1. Tenta encontrar Inscrito existente
            BEGIN
                SELECT id_inscrito INTO l_id_inscrito 
                FROM inscritos 
                WHERE email = r.email OR (nif IS NOT NULL AND nif = r.nif)
                FETCH FIRST 1 ROWS ONLY;
                
                -- ATUALIZA DADOS EXISTENTES (Upsert)
                UPDATE inscritos
                SET nome_completo = r.nome_completo,
                    telemovel = r.telemovel
                WHERE id_inscrito = l_id_inscrito;
                
            EXCEPTION WHEN NO_DATA_FOUND THEN
                -- 2. Cria se não existir
                INSERT INTO inscritos (nome_completo, email, nif, telemovel, consentimento_rgpd)
                VALUES (r.nome_completo, r.email, r.nif, r.telemovel, 'Y')
                RETURNING id_inscrito INTO l_id_inscrito;
            END;

            -- 3. (Removido) - A matrícula não é automática nesta fase.
            -- O técnico fará a seleção posteriormente.

            -- 4. Marca sucesso e guarda o link para o inscrito
            UPDATE pre_inscricoes 
            SET estado_processamento = 'SUCESSO',
                id_inscrito = l_id_inscrito
            WHERE id_pre_inscricao = r.id_pre_inscricao;
            
        EXCEPTION WHEN OTHERS THEN
             l_erro := SQLERRM;
             UPDATE pre_inscricoes SET estado_processamento = 'ERRO', log_erro = l_erro 
             WHERE id_pre_inscricao = r.id_pre_inscricao;
        END;
    END LOOP;
END;
/
```

---

## Próximo Passo
Após correr estes scripts no SQL Workshop, a sua base de dados está **pronta** para a Fase 2 (Criação da App e Ecrãs).
