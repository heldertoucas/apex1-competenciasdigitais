# Guia de Execução: Passaporte Competências Digitais
**Versão:** 2.1 (Power Automate & Native Booleans)
**Plataforma Alvo:** Oracle APEX 24.2 + Oracle 23ai

Este guia detalha a implementação técnica final, integrando base de dados moderna e correio via Power Automate.

---

## 1. Configuração do Workspace
1.  Aceda ao seu Workspace APEX.
2.  **ACL (Network):** Se estiver numa infraestrutura própria, garanta que a base de dados tem permissão (ACL) para aceder à internet (`*.azure.com` ou o domínio do Power Automate).

---

## 2. Implementação do Modelo de Dados (SQL Moderno)
*Objetivo: Criar estrutura com tipos de dados nativos.*

Copie e execute no **SQL Commands**.

### 2.1. Tabelas de Suporte
```sql
CREATE TABLE cursos (
    id_curso        NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    nome            VARCHAR2(200) NOT NULL,
    carga_horaria   NUMBER
);

CREATE TABLE turmas (
    id_turma        NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    id_curso        NUMBER REFERENCES cursos(id_curso),
    nome            VARCHAR2(200) NOT NULL,
    estado          VARCHAR2(20) DEFAULT 'ABERTA'
);
```

### 2.2. Tabelas Principais (Com Booleanos)
```sql
CREATE TABLE inscritos (
    id_inscrito         NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    nome_completo       VARCHAR2(200) NOT NULL,
    email               VARCHAR2(200) NOT NULL,
    nif                 NUMBER,
    -- Booleano Nativo (Oracle 23ai)
    consentimento_rgpd  BOOLEAN DEFAULT FALSE,
    created             TIMESTAMP DEFAULT SYSTIMESTAMP,
    CONSTRAINT uk_inscritos_email UNIQUE (email)
);

CREATE TABLE matriculas (
    id_matricula    NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    id_inscrito     NUMBER REFERENCES inscritos(id_inscrito),
    id_turma        NUMBER REFERENCES turmas(id_turma),
    token_acesso    VARCHAR2(64),
    -- Booleano para controlo de estado
    email_enviado   BOOLEAN DEFAULT FALSE,
    created         TIMESTAMP DEFAULT SYSTIMESTAMP
);
```

### 2.3. Tabela de Staging
```sql
CREATE TABLE pre_inscricoes (
    id_pre_inscricao    NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    nome_completo       VARCHAR2(200),
    email               VARCHAR2(200),
    nif                 NUMBER,
    telemovel           VARCHAR2(20),
    nome_curso_interesse VARCHAR2(200),
    estado_processamento VARCHAR2(20) DEFAULT 'PENDENTE'
);
```

### 2.4. Lógica de Token
```sql
CREATE OR REPLACE TRIGGER trg_matriculas_token
BEFORE INSERT ON matriculas
FOR EACH ROW
BEGIN
    IF :new.token_acesso IS NULL THEN
        :new.token_acesso := DBMS_RANDOM.STRING('X', 32);
    END IF;
END;
/
```

---

## 3. Criação da Aplicação
(Siga o Wizard normal do APEX: Create App -> Name "Passaporte" -> Create).

---

## 4. Importação e Processamento
*Mantenha a lógica de criar a página "Data Loading" apontada para `PRE_INSCRICOES`.*

### Processamento PL/SQL (Botão "Processar")
```sql
DECLARE
    l_id_inscrito NUMBER;
    l_id_turma    NUMBER := :P_TURMA_TARGET;
BEGIN
    FOR r IN (SELECT * FROM pre_inscricoes WHERE estado_processamento = 'PENDENTE') LOOP
        -- 1. Upsert Inscrito
        BEGIN
            SELECT id_inscrito INTO l_id_inscrito FROM inscritos WHERE email = r.email;
        EXCEPTION WHEN NO_DATA_FOUND THEN
            INSERT INTO inscritos (nome_completo, email, nif, consentimento_rgpd)
            VALUES (r.nome_completo, r.email, r.nif, TRUE) -- Assume consentimento na importação
            RETURNING id_inscrito INTO l_id_inscrito;
        END;

        -- 2. Criar Matrícula
        INSERT INTO matriculas (id_inscrito, id_turma) VALUES (l_id_inscrito, l_id_turma);

        -- 3. Fechar Staging
        UPDATE pre_inscricoes SET estado_processamento = 'PROCESSADO' WHERE id_pre_inscricao = r.id_pre_inscricao;
    END LOOP;
END;
```

---

## 5. Integração Power Automate (Emails)
*Objetivo: Substituir APEX_MAIL por chamada REST.*

### 5.1. Configuração
1.  Obtenha o **HTTP POST URL** do seu fluxo Power Automate.
2.  (Opcional, mas recomendado) Vá a **App Builder > Shared Components > Web Credentials** e crie uma entrada para guardar a chave/URL.

### 5.2. Código de Envio (Botão "Enviar Convites")
```sql
DECLARE
    l_body      CLOB;
    l_response  CLOB;
    l_url       VARCHAR2(2000) := 'https://prod-xx.westeurope.logic.azure.com:443/workflows/...'; -- O seu URL
BEGIN
    FOR r IN (
        SELECT m.id_matricula, i.nome_completo, i.email, m.token_acesso 
        FROM matriculas m
        JOIN inscritos i ON i.id_inscrito = m.id_inscrito
        WHERE m.id_matricula = :ID_SELECIONADO
    ) LOOP
        
        -- Construir JSON Payload
        l_body := JSON_OBJECT(
            'to'      VALUE r.email,
            'subject' VALUE 'Acesso ao Passaporte Digital',
            'nome'    VALUE r.nome_completo,
            'link'    VALUE APEX_UTIL.PREPARE_URL(
                          p_url => 'f?p=' || :APP_ID || ':10:::::P10_TOKEN:' || r.token_acesso,
                          p_checksum_type => 'SESSION' -- Se a página pública exigir checksum
                      )
        );

        -- Chamada REST
        l_response := APEX_WEB_SERVICE.MAKE_REST_REQUEST(
            p_url         => l_url,
            p_http_method => 'POST',
            p_body        => l_body
        );

        -- Atualizar estado (Booleano)
        UPDATE matriculas SET email_enviado = TRUE WHERE id_matricula = r.id_matricula;
        
    END LOOP;
END;
```

---

## 6. Próximos Passos
1.  Crie as tabelas com o novo script (Tipos `BOOLEAN`).
2.  Configure o fluxo no Power Automate para receber o JSON e enviar o email (Outlook Connector).
3.  Teste a integração com um email real da CML.
