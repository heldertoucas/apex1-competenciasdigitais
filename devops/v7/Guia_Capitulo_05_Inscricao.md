# Manual de Implementação - Capítulo 5: Fluxo de Inscrição e Matrícula
**Aplicação:** Academia Digital  
**Versão do Guia:** 1.0  
**Objetivo:** Gerir o ciclo de vida dos alunos nas turmas, incluindo o sistema de Matrícula em Massa.

---

## 1. Tabela de Matrículas (SQL)

A tabela de ligação entre Alunos (Entidades) e Turmas.

### 1.1. Script Matrículas
1.  **Script Name:** `05_Matriculas`.
2.  Código:

```sql
-- CAPÍTULO 5: MATRÍCULAS

CREATE TABLE Matriculas (
    ID_Matricula NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    ID_Turma NUMBER NOT NULL,
    ID_Aluno NUMBER NOT NULL,
    Token_Acesso VARCHAR2(50), -- Chave única p/ avaliações
    ID_Estado_Matricula NUMBER,
    Data_Inscricao DATE DEFAULT SYSDATE,
    Diagnostico_Respostas CLOB, -- JSON das respostas iniciais
    Data_Conclusao DATE,
    Classificacao_Final VARCHAR2(50),
    Total_Horas NUMBER,
    Avaliacao_Curso NUMBER,
    Comentario_Aluno CLOB,
    Obs_SIGO VARCHAR2(4000),
    ID_Nivel_Experiencia NUMBER,
    
    FOREIGN KEY (ID_Turma) REFERENCES Turmas(ID_Turma),
    FOREIGN KEY (ID_Aluno) REFERENCES Entidades(ID_Entidade),
    FOREIGN KEY (ID_Estado_Matricula) REFERENCES Tipos_Estado_Matricula(ID_Estado_Matricula)
);

-- Evitar duplicados: um aluno só se matricula 1 vez na mesma turma
CREATE UNIQUE INDEX UK_Matricula_Aluno_Turma ON Matriculas(ID_Turma, ID_Aluno);
```
3.  **Executar.**

---

## 2. Interface de Matrícula em Massa (Bulk Enrollment)

Este é um requisito crítico: permitir selecionar vários alunos de uma lista e matriculá-los de uma vez numa turma.

### 2.1. Preparação da Página
1.  **Create Page** > **Blank Page** (Página em Branco).
2.  **Name:** `Gestão de Matrículas em Massa`.
3.  **Adicionar Item de Filtro:**
    *   Crie uma região "Filtros".
    *   Item `P10_ID_TURMA` (Select List).
    *   Source: `SELECT Nome_Turma, ID_Turma FROM Turmas WHERE ID_Estado_Turma = (ID de 'Confirmada')`.

### 2.2. Região 1: Alunos Matriculados
1.  Crie uma região **Interactive Grid**.
2.  **Source:** `SELECT * FROM Matriculas WHERE ID_Turma = :P10_ID_TURMA`.
3.  **Title:** "Alunos Já Matriculados na Turma".
4.  Ligação ao Item Pai: `P10_ID_TURMA`.

### 2.3. Região 2: Candidatos Disponíveis (O Pool)
1.  Crie uma região **Interactive Report** (com Checkboxes).
2.  **Source:**
    ```sql
    SELECT 
        e.ID_Entidade,
        e.Nome_Completo,
        e.Email,
        e.NIF
    FROM Entidades e
    WHERE e.Ativo = 'S'
      AND NOT EXISTS (
          SELECT 1 FROM Matriculas m 
          WHERE m.ID_Aluno = e.ID_Entidade 
            AND m.ID_Turma = :P10_ID_TURMA
      )
    -- Nota: Mais tarde, filtrar apenas quem fez Pre-Inscrição no Curso da Turma
    ```
3.  **Adicionar Checkbox:**
    *   Adicione uma coluna virtual `APEX_ITEM.CHECKBOX2(1, e.ID_Entidade) as SEDELECIONAR`.
    *   *Alternativa Moderna:* Use uma Interactive Grid editável e selecione as linhas.

### 2.4. Processo de Matrícula
1.  Crie um botão **"Matricular Selecionados"**.
2.  Crie um Processo (Processing) que corre ao clicar no botão.
3.  **Código PL/SQL (Exemplo com APEX_APPLICATION.G_F01):**
    ```sql
    BEGIN
        FOR i IN 1..APEX_APPLICATION.G_F01.COUNT LOOP
             INSERT INTO Matriculas (ID_Turma, ID_Aluno, ID_Estado_Matricula)
             VALUES (:P10_ID_TURMA, APEX_APPLICATION.G_F01(i), 1); -- 1 = Inscrito
        END LOOP;
    END;
    ```

---
**Conclusão Capítulo 5:**
Agora consegue aceder a uma turma e popular a mesma com alunos vindos da base de dados global.
