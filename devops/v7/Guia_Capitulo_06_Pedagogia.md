# Manual de Implementação - Capítulo 6: Execução Pedagógica
**Aplicação:** Academia Digital  
**Versão do Guia:** 2.0 (Refatorado M:N)  
**Objetivo:** Ferramentas do dia-a-dia do Formador (Sala de Aula) e Gestão de Medalhas.

---

## 1. Dados Pedagógicos (SQL)

Tabelas para registar o que acontece na sala e as conquistas.

### 1.1. Script Pedagogia
1.  **Script Name:** `06_Pedagogia`.
2.  Código:

```sql
-- CAPÍTULO 6: PEDAGOGIA (Refatorado)

-- 1. Presenças (Assiduidade por Sessão)
CREATE TABLE Presencas (
    ID_Presenca NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    ID_Sessao NUMBER NOT NULL,
    ID_Matricula NUMBER NOT NULL,
    ID_Estado_Presenca NUMBER, -- FK
    Horas_Assistidas NUMBER,
    Data_Registo TIMESTAMP DEFAULT SYSTIMESTAMP,
    FOREIGN KEY (ID_Sessao) REFERENCES Sessoes(ID_Sessao),
    FOREIGN KEY (ID_Matricula) REFERENCES Matriculas(ID_Matricula)
);

-- 2. Avaliações (Notas por Módulo)
CREATE TABLE Avaliacoes_Modulo (
    ID_Avaliacao NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    ID_Matricula NUMBER NOT NULL,
    ID_Modulo NUMBER NOT NULL,
    Nota_Valor NUMBER,
    Feedback_Texto CLOB,
    Aprovado CHAR(1),
    FOREIGN KEY (ID_Matricula) REFERENCES Matriculas(ID_Matricula),
    FOREIGN KEY (ID_Modulo) REFERENCES Modulos(ID_Modulo)
);

-- 3. Badges Conquistados (Histórico do Aluno)
-- Refatorado para apontar para a nova tabela de Medalhas
CREATE TABLE Badges_Conquistados (
    ID_Badge_Aluno NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    ID_Matricula NUMBER NOT NULL,
    ID_Medalha NUMBER NOT NULL, -- Alterado de ID_Competencia
    ID_Turma NUMBER NOT NULL,   -- Contexto da conquista
    Data_Conquista DATE DEFAULT SYSDATE,
    URL_Evidencia VARCHAR2(500),
    FOREIGN KEY (ID_Matricula) REFERENCES Matriculas(ID_Matricula),
    FOREIGN KEY (ID_Medalha) REFERENCES Catalogo_Medalhas(ID_Medalha),
    FOREIGN KEY (ID_Turma) REFERENCES Turmas(ID_Turma)
);
```
3.  **Executar.**

---

## 2. O Portal do Formador (UI)

Uma área simplificada para o formador, idealmente optimizada para Tablets.

### 2.1. Dashboard "Minhas Turmas"
1.  **Create Page** > **Component** > **Cards**.
2.  **Page Name:** `Minhas Turmas`.
3.  **Table:** `TURMAS` (ou uma View que filtre por Formador).
4.  **Grid Cards:**
    *   **Title:** `Codigo`.
    *   **Body:** `Data_Inicio` || ' a ' || `Data_Fim`.
5.  **Actions:**
    *   Crie um botão/link no Card para ir para o **Diário de Aulas**.

---

## 3. Diário de Aulas (Gestão de Presenças)
Nesta página, o formador seleciona a Sessão e marca quem veio.

### 3.1. Criar a Página
1.  **Create Page** > **Master-Detail**.
2.  **Master Table:** `SESSOES`.
3.  **Detail Table:** `PRESENCAS`.
4.  **Master Region:** Form.
5.  **Detail Region:** Interactive Grid.

### 3.2. Botão "Gerar Lista de Presenças"
A tabela de presenças começa vazia. Precisamos de um botão para copiar os alunos da turma para a sessão.
1.  Na região das Presenças, crie um **Button** chamado `Gerar Lista`.
2.  Crie um **Process** (After Submit) ligado a esse botão.
3.  **PL/SQL Code:**
    ```sql
    -- Insere presenças para todos os alunos matriculados que ainda não tenham registo nesta sessão
    INSERT INTO Presencas (ID_Sessao, ID_Matricula, Horas_Assistidas)
    SELECT :P_ID_SESSAO, m.ID_Matricula, 0 -- Inicializa com 0 horas
      FROM Matriculas m
      JOIN Turmas t ON m.ID_Turma = t.ID_Turma
      JOIN Sessoes s ON s.ID_Turma = t.ID_Turma
     WHERE s.ID_Sessao = :P_ID_SESSAO
       AND m.Id_Estado_Matricula IN (SELECT ID FROM Tipos_Estado_Matricula WHERE Codigo = 'ATIVA') -- Apenas ativos
       AND NOT EXISTS (SELECT 1 FROM Presencas p WHERE p.ID_Matricula = m.ID_Matricula AND p.ID_Sessao = s.ID_Sessao);
    ```

---

## 4. Avaliação Modular (Pauta)
Onde o formador lança as notas.

1.  **Create Page** > **Interactive Grid**.
2.  **Name:** `Pauta da Turma`.
3.  **Table:** `AVALIACOES_MODULO`.
4.  **Master Item:** Filtre por `ID_TURMA` (terá de fazer join com Matriculas na query ou passar o ID da Turma).
    *   *Sugestão:* Use uma SQL Query como fonte para facilitar:
        ```sql
        SELECT a.ID_Avaliacao,
               m.ID_Matricula,
               p.Nome as Nome_Formando,
               mod.Nome as Nome_Modulo,
               a.Nota_Valor,
               a.Aprovado
          FROM Avaliacoes_Modulo a
          JOIN Matriculas m ON a.ID_Matricula = m.ID_Matricula
          JOIN Entidades p ON m.ID_Formando = p.ID_Entidade
          JOIN Modulos mod ON a.ID_Modulo = mod.ID_Modulo
         WHERE m.ID_Turma = :P_ID_TURMA
        ```
5.  **Botão "Inicializar Pauta":**
    *   Logica PL/SQL semelhante às presenças: `INSERT INTO Avaliacoes_Modulo ... SELECT ... FROM Matriculas CROSS JOIN Modulos WHERE ID_Turma = ...`

---

## 5. Gestão de Medalhas da Turma (Seleção do Formador)
Este é o ecrã onde o Formador decide **quais medalhas** podem ser atribuídas nesta turma.

1.  **Create Page** > **Interactive Grid**.
2.  **Page Name:** `Medalhas da Turma`.
3.  **Page Mode:** `Modal Dialog`.
4.  **Source Type:** `SQL Query`.
5.  **Query (Lógica de Seleção):**
    ```sql
    SELECT m.ID_Medalha,
           m.Nome,
           m.URL_Imagem,
           -- Verifica se o formador já selecionou esta medalha para esta turma
           CASE 
               WHEN EXISTS (SELECT 1 
                              FROM Turma_Medalhas_Elegiveis tme 
                             WHERE tme.ID_Medalha = m.ID_Medalha 
                               AND tme.ID_Turma = :P_ID_TURMA) 
               THEN 'S' ELSE 'N' 
           END as Selecionado
      FROM Catalogo_Medalhas m
     WHERE m.Ativo = 'S'
       -- Mostrar apenas medalhas que tenham a ver com o curso desta turma
       AND EXISTS (
           SELECT 1 
             FROM Competencia_Medalhas cm
             JOIN Modulo_Competencias mc ON mc.ID_Competencia = cm.ID_Competencia
             JOIN Modulos mod ON mod.ID_Modulo = mc.ID_Modulo
             JOIN Cursos c ON c.ID_Curso = mod.ID_Curso
             JOIN Turmas t ON t.ID_Curso = c.ID_Curso
            WHERE t.ID_Turma = :P_ID_TURMA
              AND cm.ID_Medalha = m.ID_Medalha
       )
    ```
6.  **Item Oculto:** Criar `P<N>_ID_TURMA`.
7.  **Coluna Checkbox (`SELECIONADO`):**
    *   **Type:** `Checkbox`.
    *   **Value:** `S` / `N`.
8.  **Processo de Gravação (PL/SQL):**
    *   **Name:** `Gravar Medalhas da Turma`.
    *   **Code:**
        > **Atenção:** Substitua `:P<N>_ID_TURMA` pelo seu item.
        ```sql
        BEGIN
            IF :SELECIONADO = 'S' THEN
                MERGE INTO Turma_Medalhas_Elegiveis dest
                USING (SELECT :P_ID_TURMA as t, :ID_MEDALHA as m FROM DUAL) src
                ON (dest.ID_Turma = src.t AND dest.ID_Medalha = src.m)
                WHEN NOT MATCHED THEN INSERT (ID_Turma, ID_Medalha, Selecionado_Por) 
                VALUES (src.t, src.m, :APP_USER);
            
            ELSIF :SELECIONADO = 'N' THEN
                DELETE FROM Turma_Medalhas_Elegiveis
                 WHERE ID_Turma = :P_ID_TURMA
                   AND ID_Medalha = :ID_MEDALHA;
            END IF;
        END;
        ```
    *   *Nota:* Este método dá ao Formador o poder de escolher, mas apenas dentro do universo de medalhas "válidas" para aquele curso (o filtro `EXISTS` na query).

---

**Conclusão Capítulo 6:**
Agora o Formador tem ferramentas para gerir o dia-a-dia "burocrático" (Presenças e Notas) e preparar a atribuição final de certificações e medalhas.
