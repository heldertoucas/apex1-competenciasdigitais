# Manual de Implementação - Capítulo 2: Gestão de Pessoas (Entidades)
**Aplicação:** Academia Digital  
**Versão do Guia:** 1.0  
**Objetivo:** Criar a base de dados de utilizadores (Formadores, Alunos, Staff) e o respetivo módulo de gestão.

---

## 1. Implementação da Estrutura de Dados (SQL)

Vamos criar as tabelas centrais onde ficará armazenada toda a informação das pessoas.

### 1.1. Criar o Script de Entidades
1.  Aceda a **SQL Workshop** > **SQL Scripts**.
2.  Clique em **Create**.
3.  **Script Name:** `02_Entidades_Core`.
4.  Copie e cole o seguinte código SQL (que já respeita as novas convenções em Português):

```sql
-- CAPÍTULO 2: GESTÃO DE PESSOAS

-- 1. Tabela Mestra de Entidades (Todas as Pessoas)
CREATE TABLE Entidades (
    ID_Entidade NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    -- Identificação
    Nome_Completo VARCHAR2(255) NOT NULL,
    NIF VARCHAR2(20),  -- Não obrigatório para Leads, mas deve ser único se existir
    Data_Nascimento DATE,
    ID_Genero NUMBER NOT NULL,   -- FK para Tipos_Genero
    Naturalidade VARCHAR2(100),
    Nacionalidade VARCHAR2(100) DEFAULT 'Portuguesa',
    
    -- Documentos
    ID_Tipo_Doc NUMBER,  -- FK para Tipos_Doc_Identificacao
    Num_Doc_Identificacao VARCHAR2(50),
    Validade_Doc DATE,
    
    -- Contactos
    Email VARCHAR2(255) NOT NULL,
    Telemovel VARCHAR2(50),
    
    -- Morada Pessoal
    Morada VARCHAR2(255),
    Codigo_Postal VARCHAR2(20),
    Localidade VARCHAR2(100),
    
    -- Dados Profissionais e Habilitações (Novos v7)
    ID_Qualificacao NUMBER,       -- FK para Tipos_De_Qualificacao
    ID_Situacao_Prof NUMBER,      -- FK para Tipos_Situacao_Profissional
    Profissao VARCHAR2(100),      -- Novo: Texto livre para profissão específica
    Entidade_Empregadora VARCHAR2(200),
    Morada_Prof VARCHAR2(255),
    Codigo_Postal_Prof VARCHAR2(20),
    Localidade_Prof VARCHAR2(100),
    Telemovel_Prof VARCHAR2(50),
    URL_CV VARCHAR2(500),         -- Link para CV (Dropbox/Drive)
    
    -- Metadados
    Consentimento_RGPD CHAR(1) DEFAULT 'N' CHECK (Consentimento_RGPD IN ('S','N')),
    Observacoes CLOB,
    Data_Criacao DATE DEFAULT SYSDATE,
    Ativo CHAR(1) DEFAULT 'S' CHECK (Ativo IN ('S','N')),
    Origem_Registo VARCHAR2(50)   -- ex: 'MANUAL', 'FORM_ONLINE'
);

-- Indices de Unicidade importantes
CREATE UNIQUE INDEX UK_Entidades_NIF ON Entidades(NIF);
CREATE UNIQUE INDEX UK_Entidades_Email ON Entidades(Email);

-- Chaves Estrangeiras (FKs)
ALTER TABLE Entidades ADD CONSTRAINT FK_Entidades_Genero FOREIGN KEY (ID_Genero) REFERENCES Tipos_Genero(ID_Genero);
ALTER TABLE Entidades ADD CONSTRAINT FK_Entidades_TipoDoc FOREIGN KEY (ID_Tipo_Doc) REFERENCES Tipos_Doc_Identificacao(ID_Tipo_Doc);
ALTER TABLE Entidades ADD CONSTRAINT FK_Entidades_Qualificacao FOREIGN KEY (ID_Qualificacao) REFERENCES Tipos_De_Qualificacao(ID_Qualificacao);
ALTER TABLE Entidades ADD CONSTRAINT FK_Entidades_SitProf FOREIGN KEY (ID_Situacao_Prof) REFERENCES Tipos_Situacao_Profissional(ID_Situacao_Prof);


-- 2. Tabela de Papéis (Roles) - Uma pessoa pode ser Formador E Aluno
CREATE TABLE Papeis_Entidade (
    ID_Papel NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    ID_Entidade NUMBER NOT NULL,
    Codigo_Papel VARCHAR2(20) NOT NULL CHECK (Codigo_Papel IN ('ADMIN', 'COORDENADOR', 'FORMADOR', 'FORMANDO', 'STAFF')),
    Data_Atribuicao DATE DEFAULT SYSDATE
);

-- FK e Unicidade (não repetir o mesmo papel para a mesma pessoa)
ALTER TABLE Papeis_Entidade ADD CONSTRAINT FK_Papeis_Entidade FOREIGN KEY (ID_Entidade) REFERENCES Entidades(ID_Entidade) ON DELETE CASCADE;
ALTER TABLE Papeis_Entidade ADD CONSTRAINT UK_Papeis_Entidade_Par UNIQUE (ID_Entidade, Codigo_Papel);
```

5.  **Executar:** Clique **Run** > **Run Now**. Verifique se obteve sucesso.

---

## 2. Criação da Interface de Gestão (Backoffice)

Vamos criar as páginas para listar, pesquisar e editar pessoas.

### 2.1. Criar Página de Relatório e Formulário
1.  Aceda ao **App Builder** e entre na aplicação "Academia Digital".
2.  Clique em **Create Page**.
3.  Selecione **Report**.
4.  Escolha a opção **Interactive Report**.
5.  **Configuração do Relatório (Page 1):**
    *   **Page Number:** O APEX sugere um (ex: 2). Pode aceitar.
    *   **Page Name:** `Diretório de Pessoas`.
    *   **Breadcrumb:** Selecione "Breadcrumb".
    *   **Form Page:** Marque a opção **"Include Form Page"** (Esta opção é fundamental para criar as duas páginas de uma vez).
6.  **Configuração do Formulário:**
    *   O APEX expandirá as opções para a página de formulário.
    *   **Page Name:** `Ficha de Entidade`.
    *   **Form Region Title:** `Dados da Pessoa`.
7.  **Fonte de Dados (Data Source):**
    *   **Table:** Selecione a tabela `ENTIDADES`.
8.  Clique em **Create**.

### 2.2. Refinar o Formulário (Page Designer)
O APEX criou o formulário, mas pôs os campos todos seguidos numa única região. Vamos organizar visualmente criando grupos.

1.  **Localizar a Região Principal:**
    *   No painel da esquerda (**Rendering**), expanda `Content Body`.
    *   Encontre a região chamada `Dados da Pessoa` (criada automaticamente pelo wizard).
2.  **Criar Sub-Regiões (Agrupadores):**
    *   Clique com o botão direito em `Dados da Pessoa` e selecione **Create Sub Region**.
    *   No painel da direita (**Property Editor**):
        *   **Title:** `Identificação`.
        *   **Type:** `Static Content`.
        *   **Template:** `Standard` (ou *Collapsible* se quiser que encolha).
    *   **Criar Sub-Região "Contactos e Morada":**
        *   Clique com o botão direito em `Dados da Pessoa` e selecione **Create Sub Region**.
        *   **Title:** `Contactos e Morada`.
        *   **Type:** `Static Content`.
        *   **Template:** `Standard`.
    *   **Criar Sub-Região "Dados Profissionais":**
        *   Clique com o botão direito em `Dados da Pessoa` e selecione **Create Sub Region**.
        *   **Title:** `Dados Profissionais`.
        *   **Type:** `Static Content`.
        *   **Template:** `Standard`.
3.  **Mover Campos (Arrastar e Largar):**
    *   Na árvore de Rendering, selecione os itens (campos) e arraste-os para dentro das novas sub-regiões:
        *   **Para `Identificação`:** `P3_NOME_COMPLETO`, `P3_NIF`, `P3_DATA_NASCIMENTO`, `P3_ID_GENERO`, `P3_ID_TIPO_DOC`, `P3_NUM_DOC_IDENTIFICACAO`.
        *   **Para `Contactos e Morada`:** `P3_EMAIL`, `P3_TELEMOVEL`, `P3_MORADA`, `P3_CODIGO_POSTAL`, `P3_LOCALIDADE`.
        *   **Para `Dados Profissionais`:** `P3_ID_SITUACAO_PROF`, `P3_PROFISSAO`, `P3_ENTIDADE_EMPREGADORA`, `P3_URL_CV`, `P3_ID_QUALIFICACAO`.
    *   *Nota:* A numeração `P3_` depende do número da sua página (se for a pág. 3). Se for outra, ajuste mentalmente.
4.  **Configurar Listas de Seleção (Drop-downs):**
    *   Selecione o campo `P3_ID_GENERO`.
    *   No painel da direita (Property Editor), altere **Type** para `Select List`.
    *   Em **List of Values**:
        *   **Type:** `SQL Query`.
        *   **SQL Query:** `SELECT Descricao d, ID_Genero r FROM Tipos_Genero ORDER BY Descricao`.
        *   **Display Null Value:** `Yes` (Label: "- Selecione -").
    *   **Configurar `ID_TIPO_DOC`:**
        *   Selecione o campo `P3_ID_TIPO_DOC`.
        *   **Type:** `Select List`.
        *   **List of Values:**
            *   **Type:** `SQL Query`.
            *   **SQL Query:** `SELECT Descricao d, ID_Tipo_Doc r FROM Tipos_Doc_Identificacao ORDER BY Descricao`.
            *   **Display Null Value:** `Yes` (Label: "- Selecione -").
    *   **Configurar `ID_QUALIFICACAO`:**
        *   Selecione o campo `P3_ID_QUALIFICACAO`.
        *   **Type:** `Select List`.
        *   **List of Values:**
            *   **Type:** `SQL Query`.
            *   **SQL Query:** `SELECT Descricao d, ID_Qualificacao r FROM Tipos_De_Qualificacao ORDER BY Ordem, Descricao`.
            *   **Display Null Value:** `Yes` (Label: "- Selecione -").
    *   **Configurar `ID_SITUACAO_PROF`:**
        *   Selecione o campo `P3_ID_SITUACAO_PROF`.
        *   **Type:** `Select List`.
        *   **List of Values:**
            *   **Type:** `SQL Query`.
            *   **SQL Query:** `SELECT Descricao d, ID_Situacao_Prof r FROM Tipos_Situacao_Profissional ORDER BY Descricao`.
            *   **Display Null Value:** `Yes` (Label: "- Selecione -").
5.  **Gravar:** Clique em **Save**.

### 2.3. Adicionar Gestão de Papéis (Mestre-Detalhe)
Dentro da ficha da pessoa, queremos dizer se ela é Formador, Aluno, etc.

1.  Ainda na página **Ficha de Entidade**, na árvore à esquerda, clique com o botão direito em "Content Body" (ou numa nova região abaixo) e escolha **Create Region**.
2.  **Title:** `Papéis no Sistema`.
3.  **Type:** `Interactive Grid`.
4.  **Source:**
    *   **Table:** `PAPEIS_ENTIDADE`.
    *   **Where Clause:** `ID_ENTIDADE = :P3_ID_ENTIDADE` (Substitua P3 pelo número real da sua página).
    *   **Page Items to Submit:** `P3_ID_ENTIDADE`.
5.  **Configuração Master-Detail:**
    *   Selecione a coluna `ID_ENTIDADE` na Grid.
    *   Na direita, em **Default**: Type = `Item`, Item = `P3_ID_ENTIDADE`.
    *   Marque a coluna como **Hidden** (o utilizador não precisa de a ver, é automático).
6.  **Coluna Código Papel:**
    *   Altere o tipo para `Select List`.
    *   **Static Values:** `STATIC:Administrador;ADMIN,Coordenador;COORDENADOR,Formador;FORMADOR,Formando;FORMANDO,Staff;STAFF`
7.  **Gravar e Testar:** Execute a página. Tente criar uma pessoa e atribuir-lhe papéis.

---

**Conclusão do Capítulo 2:**
Tem agora o "Coração" do sistema: uma base de dados de pessoas robusta e organizada, pronta para ser matriculada em cursos. Validou a criação de Lookups e a relação Mestre-Detalhe.
